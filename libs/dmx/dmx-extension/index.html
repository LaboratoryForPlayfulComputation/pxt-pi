<!DOCTYPE HTML>
<html>
<head>
  <title>Node DMX app!</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="./libraries/p5.min.js"></script>
  <script src="./libraries/p5.dom.min.js"></script>
  <link rel="stylesheet" href="./style.css">
  <script src="./index.js"></script>
  <script src="./fixtureeditmode.js"></script>
  <script src="./dmxcontroller.js"></script>
  <script src="./universe.js"></script>
  <script src="./fixture.js"></script>
  <script src="./rgbfixture.js"></script>
  <script src="./channel.js"></script>
  <script src="./cable.js"></script>
  <script src="./downloadProject.js"></script>
  <script src="./uploadProject.js"></script>
  <script src="./updateDMXServer.js"></script>
  <script src="./pattern.js"></script>
  <script src="./scene.js"></script>
  <script src="./devices.js"></script>
</head>
<body>
  <div id="fixture-editor"></div>

  <script>
    var extId = window.location.hash.substr(1);
    var hosted = false;
    var idToType = {};
    var usercode = {};
    function receiveMessage(ev) {
        var msg = ev.data;
        var action = idToType[msg.id];
        if (action) {
            console.debug('neoanim received ' + action);
            switch (action) {
                case "extinit":
                    hosted = true;
                    console.log('host connection completed')
                    sendRequest("extreadusercode");
                    break;
                case "extreadusercode":
                    usercode = msg.resp || {};
                    break;
            }
            delete idToType[msg.id];
        }
    }
    function mkRequest(action) {
        var id = Math.random().toString();
        idToType[id] = action;
        return {
            type: "pxtpkgext",
            action: action,
            extId: extId,
            response: true,
            id: id
        }
    }
    function isIFrame() {
        try {
            return window && window.self !== window.top;
        } catch (e) {
            return true;
        }
    }
    function sendRequest(action, body) {
        if (!isIFrame()) return;
        var msg = mkRequest(action);
        msg.body = body;
        window.parent.postMessage(msg, "*");
    }
    function renderUserCode() {
        var ts = `// This file was autogenerated, do not edit...
namespace dmx {
`
        var images = JSON.stringify(usercode.json);
        Object.keys(usercode).forEach(function (fileName) {
            ts +=
                `
/*
* An awesome animation
*/
//% fixedInstance block="${fileName.replace(/[_-]/g, ' ')}" jres=light.theaterChaseAnimation chase" blockIdentity="light._animationPicker"    
export const ${fileName.replace(/[_-]/g, '')}Animation = light.animationSheet(hex \`${usercode[fileName]}\`);
`
        })
        ts += `
}`
        return ts;
    }
    function saveUserCode(fileName, out) {            
        usercode[fileName.toLowerCase()] = out;
        var ts = renderUserCode();
        sendRequest("extwritecode", {
            code: ts,
            json: JSON.stringify(usercode, null, 2)
        })
        /*preview.innerText = 'Animation saved...';
        output.innerText = ts;
        outputext.style.display = 'block';
        selectOutput();*/
    }


    document.onreadystatechange = function (er) {
        if (document.readyState != "complete") return;
        window.addEventListener("message", receiveMessage, false);
        sendRequest("extinit")
    }
</script>
</body>
</html>
